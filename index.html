<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Annual Timeline</title>
    
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            overflow-x: scroll;
        }
        #timeline {
            position: relative;
            padding: 40px;
            border-top: 1px solid #ccc;
            white-space: nowrap;
        }
        .tick {
            position: absolute;
            top: 0;
            height: 10px;
            border-left: 1px solid #999;
            text-align: center;
            font-size: 12px;
            transform: translateX(-1px);
        }
        .bar {
            position: absolute;
            height: 20px;
            border-radius: 4px;
            opacity: 0.9;
        }
        .label {
            position: absolute;
            font-size: 12px;
            margin-top: -2px;
            margin-left: 5px;
            white-space: nowrap;
        }
    </style>
  </head>
  
  <body>
    <div id="timeline"></div>
    
    <script>
        const timeline = document.getElementById("timeline");

        // --- Communication GRIST MODERNE ---
        window.grist.ready({
            requiredAccess: 'read table'
        });

        // Réception des données
        window.grist.onRecords((records) => {
            console.log("RECORDS:", records);
            render(records);
        });

        // --- Rendu du widget ---
        function render(records) {
            timeline.innerHTML = "";

            if (!records || !records.length) {
                console.warn("Aucun enregistrement reçu.");
                return;
            }

            // Extraire les années
            const startYears = records
                .map(r => r.hasStartYear)
                .filter(v => typeof v === "number");

            if (!startYears.length) {
                console.warn("Aucun hasStartYear valide.");
                return;
            }

            const endYears = records.map(r =>
                (typeof r.hasEndYear === "number") ? r.hasEndYear : r.hasStartYear
            );

            const minYear = Math.min(...startYears) - 5;
            const maxYear = Math.max(...endYears) + 5;

            const SCALE = 10; // 10px = 1 an

            // --- Graduations tous les 10 ans ---
            for (let year = Math.floor(minYear / 10) * 10; year <= maxYear; year += 10) {
                const tick = document.createElement("div");
                tick.className = "tick";
                tick.style.left = (year - minYear) * SCALE + "px";
                tick.innerHTML = `<div style="margin-top:12px">${year}</div>`;
                timeline.appendChild(tick);
            }

            // --- Affichage des barres ---
            let yOffset = 40;

            records.forEach((r) => {
                if (typeof r.hasStartYear !== "number") return;

                const start = r.hasStartYear;
                const end = (typeof r.hasEndYear === "number") ? r.hasEndYear : start;
                const color = r.hasColor || "#777";

                // Barre
                const bar = document.createElement("div");
                bar.className = "bar";
                bar.style.left = (start - minYear) * SCALE + "px";
                bar.style.top = yOffset + "px";
                bar.style.width = Math.max(2, (end - start) * SCALE) + "px"; // largeur min 2px
                bar.style.background = color;

                // Label
                const label = document.createElement("div");
                label.className = "label";
                label.style.left = (start - minYear) * SCALE + "px";
                label.style.top = (yOffset + 22) + "px";
                label.textContent = `${start}–${end}`;

                timeline.appendChild(bar);
                timeline.appendChild(label);

                yOffset += 50;
            });

            timeline.style.width = (maxYear - minYear) * SCALE + 200 + "px";
        }
    </script>
  </body>
</html>
