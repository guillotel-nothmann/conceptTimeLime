<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Concept Timeline</title>
    <style>
    body {
      font-family: sans-serif;
      margin: 0;
    }

    #gantt-container {
      position: relative;
      border: 1px solid #ccc;
      height: 400px;
      overflow-x: auto;
      padding-top: 40px;
      padding-left: 160px; /* pour laisser la place à l'axe vertical */
    }

    #controls {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 4px;
      z-index: 10;
      border-bottom: 1px solid #ccc;
    }

    #controls button {
      margin-right: 4px;
    }

    #timeline {
      position: relative;
      height: 400px;
      white-space: nowrap;
    }

    .tick {
      position: absolute;
      top: 0;
      height: 10px;
      border-left: 1px solid #999;
      font-size: 12px;
      text-align: center;
      transform: translateX(-1px);
    }

    .bar {
      position: absolute;
      height: 20px;
      border-radius: 4px;
      opacity: 0.9;
    }

    .label {
      position: absolute;
      font-size: 12px;
      margin-top: -2px;
      margin-left: 5px;
      white-space: nowrap;
    }

    .y-axis-label {
      position: absolute;
      font-size: 12px;
      text-align: right;
      width: 140px;
      right: 100%;
      margin-right: 10px;
      white-space: nowrap;
    }
  </style>
  </head>
  
  <body>
    <div id="gantt-container">
      <div id="controls">
        <button onclick="zoomOut()">-</button>
        <button onclick="zoomIn()">+</button>
        <span id="zoom-level">Zoom: 1x</span>
      </div>
      <div id="timeline"></div>
    </div>
    
    <script>
    const timeline = document.getElementById("timeline");
    const zoomLevelSpan = document.getElementById("zoom-level");

    let recordsData = [];
    let scale = 10; // px par an initial

    // --- Initialisation GRIST ---
    if (window.grist) {
      window.grist.ready({
        columns: ["hasStartYear", "hasEndYear", "hasColor", "hasName"]
      });

      window.grist.onRecords((records) => {
        recordsData = records.map(r => ({
          hasStartYear: r.hasStartYear,
          hasEndYear: r.hasEndYear,
          hasColor: r.hasColor,
          hasName: r.hasName
        }));
        fitToScreen();
      });
    }

    function renderTimeline() {
      timeline.innerHTML = "";
      if (!recordsData.length) return;

      const startYears = recordsData.map(r => r.hasStartYear).filter(v => v != null);
      const endYears = recordsData.map(r => r.hasEndYear != null ? r.hasEndYear : r.hasStartYear);
      const minYear = Math.min(...startYears) - 5;
      const maxYear = Math.max(...endYears) + 5;

      // --- Axe horizontal (ticks par décennie) ---
      for (let year = Math.floor(minYear/10)*10; year <= maxYear; year += 10) {
        let tick = document.createElement("div");
        tick.className = "tick";
        tick.style.left = (year - minYear) * scale + "px";
        tick.innerHTML = `<div style="margin-top:12px">${year}</div>`;
        timeline.appendChild(tick);
      }

      // --- Barres avec labels verticaux ---
      let yOffset = 20;

      recordsData.forEach(r => {
        if (r.hasStartYear == null) return;

        const start = r.hasStartYear;
        const end = r.hasEndYear || r.hasStartYear;
        const color = r.hasColor || "#777";
        const name = r.hasName || "";

        // Barre
        let bar = document.createElement("div");
        bar.className = "bar";
        bar.style.left = (start - minYear) * scale + "px";
        bar.style.top = yOffset + "px";
        bar.style.width = ((end - start) * scale) + "px";
        bar.style.background = color;

        // Label année
        let label = document.createElement("div");
        label.className = "label";
        label.style.left = (start - minYear) * scale + "px";
        label.style.top = (yOffset + 22) + "px";
        label.textContent = `${start}–${end}`;

        // Label vertical
        let yLabel = document.createElement("div");
        yLabel.className = "y-axis-label";
        yLabel.style.top = yOffset + "px";
        yLabel.textContent = name;

        timeline.appendChild(yLabel);
        timeline.appendChild(bar);
        timeline.appendChild(label);

        yOffset += 50;
      });

      timeline.style.width = (maxYear - minYear) * scale + 200 + "px";
    }

    // --- Zoom ---
    function zoomIn() {
      scale *= 1.5;
      zoomLevelSpan.textContent = `Zoom: ${scale.toFixed(1)}px/an`;
      renderTimeline();
    }

    function zoomOut() {
      scale /= 1.5;
      zoomLevelSpan.textContent = `Zoom: ${scale.toFixed(1)}px/an`;
      renderTimeline();
    }

    // --- Ajustement automatique pour tenir l’écran ---
    function fitToScreen() {
      if (!recordsData.length) return;
      const containerWidth = document.getElementById("gantt-container").offsetWidth;
      const startYears = recordsData.map(r => r.hasStartYear).filter(v => v !== null);
      const endYears = recordsData.map(r => r.hasEndYear || r.hasStartYear);
      const minYear = Math.min(...startYears);
      const maxYear = Math.max(...endYears);
      scale = containerWidth / (maxYear - minYear + 10);
      zoomLevelSpan.textContent = `Zoom: ${scale.toFixed(1)}px/an`;
      renderTimeline();
    }
  </script>
  </body>
</html>
