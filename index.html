<div id="timeline-widget" style="width: 100%; height: 500px; border: 1px solid #ccc;"></div>
  <div style="margin-top: 10px;">
    <button id="zoom-out">-</button>
    <span id="zoom-factor">Zoom: 1x</span>
    <button id="zoom-in">+</button>
  </div>
  
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
(async function() {
  const container = d3.select("#timeline-widget");
  const width = container.node().clientWidth;
  const height = container.node().clientHeight;
  let zoomFactor = 1;

  // Marges pour axes
  const margin = { top: 20, right: 20, bottom: 40, left: 120 };
  const innerWidth = width - margin.left - margin.right;
  const innerHeight = height - margin.top - margin.bottom;

  const svg = container.append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  // Échelles
  const xScale = d3.scaleLinear().range([0, innerWidth]);
  const yScale = d3.scaleBand().range([0, innerHeight]).padding(0.1);

  const xAxisG = g.append("g")
    .attr("transform", `translate(0, ${innerHeight})`);
  const yAxisG = g.append("g");

  const zoomSpan = d3.select("#zoom-factor");

  function render(data) {
    // Définir domaines
    const xMin = d3.min(data, d => d.startYear);
    const xMax = d3.max(data, d => d.endYear);
    xScale.domain([xMin, xMax]).nice();

    yScale.domain(data.map(d => d.hasName));

    // Axes
    xAxisG.call(d3.axisBottom(xScale).ticks(10).tickFormat(d3.format("d")));
    yAxisG.call(d3.axisLeft(yScale));

    // Rectangles
    const bars = g.selectAll(".bar").data(data, d => d.hasName);

    bars.enter()
      .append("rect")
      .attr("class", "bar")
      .merge(bars)
      .attr("x", d => xScale(d.startYear))
      .attr("y", d => yScale(d.hasName))
      .attr("width", d => xScale(d.endYear) - xScale(d.startYear))
      .attr("height", yScale.bandwidth())
      .attr("fill", "tomato");

    bars.exit().remove();
  }

  function applyZoom(factor, data) {
    zoomFactor *= factor;
    const xDomain = xScale.domain();
    const mid = (xDomain[0] + xDomain[1]) / 2;
    const range = (xDomain[1] - xDomain[0]) / factor / 2;
    xScale.domain([mid - range, mid + range]);
    render(data);
    zoomSpan.text(`Zoom: ${zoomFactor.toFixed(1)}x`);
  }

  // Zoom buttons
  d3.select("#zoom-in").on("click", () => applyZoom(1.2, currentData));
  d3.select("#zoom-out").on("click", () => applyZoom(0.8, currentData));

  // --- Connexion Grist ---
  let currentData = [];

  if (window.grist) {
    window.grist.ready().then(() => {
      window.grist.onRecords((records) => {
        // Transformation minimale pour s'assurer que les champs sont des nombres
        currentData = records.map(r => ({
          startYear: +r.startYear,
          endYear: +r.endYear,
          hasName: r.hasName
        }));
        render(currentData);
      });
    });
  } else {
    console.warn("Grist API not found");
  }
})();
</script>
  